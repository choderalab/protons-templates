{% block imports %}
{# This contains all necessary import statements #}
{% endblock %}
{% block benchmark_settings %}{# Important settings for the benchmark, such as the state, and ncmc steps #}{% endblock %}
{% block timeout_handlers %}
{# Default handling of timeouts #}
# Define what to do on timeout
class TimeOutError(RuntimeError):
    """This error is raised when an operation is taking longer than expected."""
    pass

def timeout_handler(signum, frame):
   log.warn("Script is running out of time. Attempting to exit cleanly.")
   raise TimeOutError("Running out of time, shutting down!")

# Register the timeout handling
signal.signal(signal.SIGALRM, timeout_handler)
{% endblock %}

{% block simulation_input %}{# Input files for this simulation #}{% endblock %}
{% block simulation_output %}{# Naming of output files #}{% endblock %}
{% block integrator_settings %}{# Integratior settings such as timestep, collision rate #}{% endblock %}
{% block integrator_def %}{# Contains a GBAOAB custom integrator definition #}{% endblock %}
{% block dynamics_settings %}{# How many MD steps before start of MC, and between MC moves. #}{% endblock %}
{% block driver_settings %}{# Settings for the proton drive #}{% endblock %}
{% block minimization_settings %}{# Settings that affect pre-simulation minimization #}{% endblock %}
{# Time before script gracefully exits #}
# Script specific settings
script_timeout = {{ script.timeout|default('428400') }} # 119 hours

{% block platform_settings %}{# Settings that define the platform, and its properties #}{% endblock %}
{% block system_settings %}{# Sets up an openmm System object and adds barostats & sets switching distance#}
{# Defines settings such as temperature, pressure #}{% endblock %}
{% block integrator_init %}{# Instantiate a GBAOAB customintegrator #}{% endblock %}
{% block new_drive %}{# Defines a new protondrive from forcefield, system and topology #}{% endblock %}

{% block start_simulation %}{# Start a new ConstantPHCalibration #}{% endblock %}
{% block saltswap %}{# Add a salinator to the system for salt management#}{% endblock %}
{% block reporters %}{# Reporters for generic constant-pH simulation #}{% endblock %}
# Raises an exception if the simulation runs out of time, so that the script can be killed cleanly from within python
signal.alarm(script_timeout)

try:
    for i in range(total_iterations):
{% block inner_loop %}
        {# The main simulation, calibration loop, needs indent of two #}
{% endblock %}
    # Reset timer
    signal.alarm(0)

except TimeOutError:
    log.warn("Simulation ran out of time, saving current results.")

finally:
    # export the context
    serialize_state(simulation.context,output_context_xml)
    # export the driver
    serialize_drive(simulation.drive, output_drive_xml)    

    ncfile.close()

# End of script
